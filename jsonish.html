<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>jsonish.rb</title>
  <link rel="stylesheet" href="http://github.com/jashkenas/docco/raw/0.3.0/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="jsonish.html">jsonish.rb</a>
          <a class="source" href="mpq.html">mpq.rb</a>
          <a class="source" href="replay_file.html">replay_file.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>jsonish.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>MPQ files store some data in a serialized format that&rsquo;s strikingly similar to
JSON, so I&rsquo;ve called it <strong>JSONish</strong>. It&rsquo;s a fairly simple format, documented
at http://github.com/GraylinKim/sc2reader/wiki/serialized.data and at
http://teamliquid.net/forum/viewmessage.php?topic_id=117260&amp;currentpage=3#45.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">MPQ</span>
  <span class="k">module</span> <span class="nn">JSONish</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p><code>parse</code> is the public API here, the following two methods are simply
helpers.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">parse</span> <span class="n">data</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">parse_recur</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span> <span class="n">data</span>
    <span class="k">end</span>
  </pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>JSONish consists of strings, arrays, maps, and integers. The first byte
of each of these indicates which is about to follow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">parse_recur</span> <span class="n">data</span>
      <span class="k">case</span> <span class="n">data</span><span class="o">.</span><span class="n">slice!</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">bytes</span><span class="o">.</span><span class="n">next</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p><code>02</code> indicates a string. The next byte is a variable-length integer
(see below) indicating the string&rsquo;s length, and the remaining bytes are
the string itself.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">when</span> <span class="mi">2</span>
        <span class="n">data</span><span class="o">.</span><span class="n">slice!</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vlf</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p><code>04</code> is an array, a list of values. Each value indicates its type, so
this is largely just a recursive process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">when</span> <span class="mi">4</span>
        <span class="n">data</span><span class="o">.</span><span class="n">slice!</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span>
        <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">vlf</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">parse_recur</span> <span class="n">data</span> <span class="p">}</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p><code>05</code> starts a map, also known as a Hash or an object literal. It maps
keys to values. In JSONish, keys are always variable-length integers,
while values can be anything.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">when</span> <span class="mi">5</span>
        <span class="no">Hash</span><span class="o">.</span><span class="n">[</span><span class="o">]</span><span class="p">((</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">vlf</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> 
          <span class="o">[</span><span class="n">vlf</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">parse_recur</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">]</span>
        <span class="k">end</span><span class="p">)</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p><code>06</code> is a single-byte integer.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">when</span> <span class="mi">6</span>
        <span class="n">data</span><span class="o">.</span><span class="n">slice!</span> <span class="mi">0</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p><code>07</code> is a four-byte integer in little-endian format.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">when</span> <span class="mi">7</span>
        <span class="n">data</span><span class="o">.</span><span class="n">slice!</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p><code>09</code> is a standalone (i.e. not a key or length) variable-length integer.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">when</span> <span class="mi">9</span>
        <span class="n">vlf</span> <span class="n">data</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>If there are other types in JSONish, we don&rsquo;t know about them.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">else</span>
        <span class="kp">nil</span>
      <span class="k">end</span>
    <span class="k">end</span>
  </pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>A variable-length integer is a concise serialization of an
arbitrary-precision integer. Each byte (except the last) sets the high bit
to <code>1</code> to indicate that the next byte is included in the integer. Seven
bits of each byte, plus all eight bits of the final byte, make up the
final number in little-endian format.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">vlf</span> <span class="n">data</span>
      <span class="n">ret</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
      <span class="kp">loop</span> <span class="k">do</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">slice!</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="kp">nil</span> <span class="k">unless</span> <span class="n">char</span>
        <span class="n">byte</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">bytes</span><span class="o">.</span><span class="n">next</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">shift</span><span class="p">)</span>
        <span class="k">break</span> <span class="k">if</span> <span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x80</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">shift</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">end</span>
      <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
